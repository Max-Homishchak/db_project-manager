# Реалізація інформаційного та програмного забезпечення

## SQL-скрипт для створення на початкового наповнення бази даних

```mysql
-- MySQL Script generated by MySQL Workbench
-- Fri Nov 10 19:30:08 2023
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `mydb` ;

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

-- -----------------------------------------------------
-- Table `mydb`.`User`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`User` ;

CREATE TABLE IF NOT EXISTS `mydb`.`User` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nickname` VARCHAR(255) NOT NULL,
  `email` VARCHAR(255) NOT NULL,
  `password` VARCHAR(255) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `avatar` VARCHAR(255) NULL,
  `blockStatus` TINYINT NULL,
  PRIMARY KEY (`id`));


-- -----------------------------------------------------
-- Table `mydb`.`Role`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Role` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Role` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`));


-- -----------------------------------------------------
-- Table `mydb`.`Project`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Project` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Project` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  `description` VARCHAR(255) NULL,
  `manager` VARCHAR(255) NOT NULL,
  `isArchived` TINYINT NULL,
  PRIMARY KEY (`id`));


-- -----------------------------------------------------
-- Table `mydb`.`Team`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Team` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Team` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  `Project_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_Team_Project1`
    FOREIGN KEY (`Project_id`)
    REFERENCES `mydb`.`Project` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX `fk_Team_Project1_idx` ON `mydb`.`Team` (`Project_id` ASC) VISIBLE;


-- -----------------------------------------------------
-- Table `mydb`.`Collaborator`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Collaborator` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Collaborator` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `User_id` INT NOT NULL,
  `Role_id` INT NOT NULL,
  `Team_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_Collaborator_User`
    FOREIGN KEY (`User_id`)
    REFERENCES `mydb`.`User` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Collaborator_Role1`
    FOREIGN KEY (`Role_id`)
    REFERENCES `mydb`.`Role` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Collaborator_Team1`
    FOREIGN KEY (`Team_id`)
    REFERENCES `mydb`.`Team` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX `fk_Collaborator_User_idx` ON `mydb`.`Collaborator` (`User_id` ASC) VISIBLE;

CREATE INDEX `fk_Collaborator_Role1_idx` ON `mydb`.`Collaborator` (`Role_id` ASC) VISIBLE;

CREATE INDEX `fk_Collaborator_Team1_idx` ON `mydb`.`Collaborator` (`Team_id` ASC) VISIBLE;


-- -----------------------------------------------------
-- Table `mydb`.`Permission`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Permission` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Permission` (
  `id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`));


-- -----------------------------------------------------
-- Table `mydb`.`Grant`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Grant` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Grant` (
  `Permission_id` INT NOT NULL,
  `Role_id` INT NOT NULL,
  CONSTRAINT `fk_Grant_Permission1`
    FOREIGN KEY (`Permission_id`)
    REFERENCES `mydb`.`Permission` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Grant_Role1`
    FOREIGN KEY (`Role_id`)
    REFERENCES `mydb`.`Role` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX `fk_Grant_Permission1_idx` ON `mydb`.`Grant` (`Permission_id` ASC) VISIBLE;

CREATE INDEX `fk_Grant_Role1_idx` ON `mydb`.`Grant` (`Role_id` ASC) VISIBLE;


-- -----------------------------------------------------
-- Table `mydb`.`Task`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Task` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Task` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  `description` VARCHAR(255) NULL,
  `deadline` DATETIME NULL,
  `priority` VARCHAR(45) NULL,
  `difficulty` VARCHAR(45) NULL,
  `Project_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_Task_Project1`
    FOREIGN KEY (`Project_id`)
    REFERENCES `mydb`.`Project` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX `fk_Task_Project1_idx` ON `mydb`.`Task` (`Project_id` ASC) VISIBLE;


-- -----------------------------------------------------
-- Table `mydb`.`Assignment`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mydb`.`Assignment` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Assignment` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `datetime` DATETIME NOT NULL,
  `Task_id` INT NOT NULL,
  `Collaborator_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_Assignment_Task1`
    FOREIGN KEY (`Task_id`)
    REFERENCES `mydb`.`Task` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Assignment_Collaborator1`
    FOREIGN KEY (`Collaborator_id`)
    REFERENCES `mydb`.`Collaborator` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE INDEX `fk_Assignment_Task1_idx` ON `mydb`.`Assignment` (`Task_id` ASC) VISIBLE;

CREATE INDEX `fk_Assignment_Collaborator1_idx` ON `mydb`.`Assignment` (`Collaborator_id` ASC) VISIBLE;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;


-- Test Data

-- Adding into `mydb`.`Role`
INSERT INTO `mydb`.`Role` (`name`)
VALUES
    ('Administrator'),
    ('Team-lead'),
    ('Collaborator');

-- Adding into `mydb`.`Permission`
INSERT INTO `mydb`.`Permission` (`role`, `name`)
VALUES        
    ('Team-lead', 'EditProfile'),
    ('Team-lead', 'CreateTask'),
    ('Team-lead', 'EditTask'),
    ('Team-lead', 'DeleteTask'),            
    ('Team-lead', 'CreateProject'),
    ('Team-lead', 'EditProject'),
    ('Team-lead', 'DeleteProject'),    
    ('Team-lead', 'ArchiveProject'),    
    ('Team-laed', 'AddCollaborator'),
    ('Team-lead', 'DeleteCollaborator'),
        
    ('Collaborator', 'EditProfile'),
    ('Collaborator', 'CreateTask'),
    ('Collaborator', 'EditTask'),
    ('Collaborator', 'DeleteTask'),
    
    ('Administrator', 'AssignManager'),
    ('Administrator', 'BanUser'),
    ('Administrator', 'UnBanUser');
    ('Administrator', 'Support');

-- Adding into `mydb`.`Grant`
INSERT INTO `db_coursework`.`Grant` (`Permission_id`, `Role_id`)
VALUES
    (1, 1),
    (1, 2),
    (1, 3),

    (2, 1),
    (2, 2),

    (3, 1),
    (3, 2),

    (4, 1),
    (4, 2),
    
    (5, 1),    

    (6, 1),    

    (7, 1),

    (8, 1),

    (9, 1),

    (10, 1),

    (11, 3),

    (12, 3),

    (13, 3),    

    (14, 3),    


-- Adding into `mydb`.`Project`
INSERT INTO `mydb`.`Project` (`name`, `description`, `manager`, `isArchived`)
VALUES
    ('Project_0', 'Description_0', 'Team-lead_0', 'false'),
    ('Project_1', 'Description_1', 'Team-lead_1', 'true'),

-- Додавання даних в таблицю `mydb`.`Team`
INSERT INTO `db_coursework`.`Team` (`name`, `Project_id`)
VALUES
    ('Team_0', 'Project_0'),
    ('Team_1', 'Project_1'),

-- Adding into `mydb`.`User`
INSERT INTO `db_coursework`.`User` (`nickname`, `email`, `password`, `avatar`, `blockStatus`)
VALUES
    ('User_0', 'user_0@mail.com', 'password_0', './photo', false),
    ('User_1', 'user_1@mail.com', 'password_1', './photo', true);

-- Adding into `mydb`.`Collaborator`
INSERT INTO `mydb`.`Collaborator` ( `User_id`, `Role_id`, `Team_id`)
VALUES
    ('0', '0', '0'),
    ('1', '1', '1'),


-- Adding into ` `mydb`.`Task`
INSERT INTO `mydb`.`Task` (`name`, `description`, `deadline`, `priority`, `difficulty`, `Project_id`)
VALUES
    ('Task_0', 'Description_0', '01-01-2023 12:00:00', 'High', 'Low', 'Project_0'),    
    ('Task_1``, 'Description_1', '01-01-2023 12:00:00', 'Low', 'High', 'Project_1'),    

-- Adding into `mydb`.`Assignment`
INSERT INTO `mydb`.`Assignment` (`datetime`, `Task_id`, `Collaborator_id`)
VALUES
    ('2023-01-01 12:00:00', 0, 0),
    ('2023-01-01 12:00:00', 1, 1),    


COMMIT;

```

## RESTfull сервіс для управління даними

### Клас запуску проекту

```java
@SpringBootApplication
public class FlowlyApplication {

	public static void main(String[] args) {
		SpringApplication.run(FlowlyApplication.class, args);
	}

}
```

### Апі контролер для комунікації з функіоналом для користувачів 

```java
@RestController
@RequestMapping("/api/v1/users")
public class UserController {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    @PostMapping
    public ResponseEntity<Long> registerUser(@RequestBody RegisterRequest request) {
        return new ResponseEntity<>(userService.registerUser(request), HttpStatus.CREATED);
    }

    @PutMapping
    public ResponseEntity<Long> updateUser(@RequestBody UserUpdateRequest request) {
        return new ResponseEntity<>(userService.updateUser(request), HttpStatus.OK);
    }

    @DeleteMapping("/{userId}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void deleteUser(@PathVariable Long userId) {
        userService.deleteUser(userId);
    }
}
```

### Апі контролер для комунікації з функіоналом для завдань
```java
@RestController
@RequestMapping("/api/v1/tasks")
public class TaskController {

    private final TaskService taskService;

    public TaskController(TaskService taskService) {
        this.taskService = taskService;
    }

    @PostMapping
    public Long createTask(@RequestBody TaskCreationRequest request) {
        return taskService.createTask(request);
    }

    @PutMapping
    public Long updateTask(@RequestBody TaskUpdateRequest request) {
        return taskService.updateTask(request);
    }

    @DeleteMapping("/{taskId}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void deleteTask(@PathVariable Long taskId) {
        taskService.deleteTask(taskId);
    }
}
```

### Ексепшини проекта
```java
public class IncorrectOldPasswordValidationException extends RuntimeException {
    public IncorrectOldPasswordValidationException(String message) {
        super(message);
    }
}

public class TaskNotFoundException extends RuntimeException {
    public TaskNotFoundException(String message) {
        super(message);
    }
}

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String message) {
        super(message);
    }
}
```

### Реквести та респонси

```java
public record RegisterRequest(String username, String password) {
}

public record UserUpdateRequest(Long userId, String username, String newPassword) {
}

public record TaskCreationRequest(String title, String description, Long reporterId, Long assigneeId) {
}

public record TaskUpdateRequest(Long taskId, String title, String description, Long assigneeId) {
}
```

### Обєкти головних сутностей в базі даних 

```java
@Entity
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder
public class Task {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String title;
    private String description;

    @ManyToOne(cascade = CascadeType.PERSIST)
    private User reporter;

    @ManyToOne(cascade = CascadeType.PERSIST)
    private User assignees;

    @OneToMany
    private Set<TaskComment> comments;
}

@Entity
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder
public class TaskComment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String message;

    @ManyToOne(cascade = CascadeType.PERSIST)
    private Task task;
}

@Entity
@NoArgsConstructor
@AllArgsConstructor
@Data
@Builder
@Table(name = "users")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String username;
    private String password;

    @OneToMany(mappedBy = "reporter")
    private Set<Task> reportedTasks;

    @ManyToMany
    private Set<Task> assignedTasks;
}
```

### Репозиторії для комунікації з бд

```java
public interface TaskRepository extends JpaRepository<Task, Long> {
}

public interface UserRepository extends JpaRepository<User, Long> {
}
```

### Сервіс для бізнес логіки щодо користувачів

```java
public interface UserService {
    User getUserById(Long userId);
    Long registerUser(RegisterRequest request);
    Long updateUser(UserUpdateRequest request);
    void deleteUser(Long userId);
}

@Service
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final ValidatorService validatorService;

    public UserServiceImpl(UserRepository userRepository, ValidatorService validatorService) {
        this.userRepository = userRepository;
        this.validatorService = validatorService;
    }

    @Override
    public User getUserById(Long userId) {
        return getUserOrThrowException(userId);
    }

    @Override
    public Long registerUser(RegisterRequest request) {
        User user = User.builder()
                .username(request.username())
                .password(request.password()) // should be encrypted
                .build();

        return userRepository.save(user).getId();
    }

    @Override
    public Long updateUser(UserUpdateRequest request) {
        User userToBeUpdated = getUserOrThrowException(request.userId());

        if (validatorService.validateOldUserPassword(userToBeUpdated, request.newPassword())) {
            throw new IncorrectOldPasswordValidationException("You have entered incorrect old password");
        }

        userToBeUpdated.setUsername(request.username());
        userToBeUpdated.setPassword(request.newPassword());
        return userRepository.save(userToBeUpdated).getId();
    }

    @Override
    public void deleteUser(Long userId) {
        userRepository.deleteById(userId);
    }

    private User getUserOrThrowException(Long userId) {
        return userRepository.findById(userId).orElseThrow(
                () -> new UserNotFoundException(String.format("User with id:%d was not found", userId)));
    }
}
```

### Сервіс для бізнес логіки щодо завдань

```java
public interface TaskService {
    Long createTask(TaskCreationRequest request);
    Long updateTask(TaskUpdateRequest request);
    void deleteTask(Long taskId);
}
@Service
public class TaskServiceImpl implements TaskService {

    private final TaskRepository taskRepository;
    private final UserService userService;

    public TaskServiceImpl(TaskRepository taskRepository, UserService userService) {
        this.taskRepository = taskRepository;
        this.userService    = userService;
    }

    @Override
    public Long createTask(TaskCreationRequest request) {
        User reporter = userService.getUserById(request.reporterId());
        User assignee = userService.getUserById(request.assigneeId());

        Task taskToBeCreated = Task.builder()
                .title(request.title())
                .description(request.description())
                .reporter(reporter)
                .assignees(assignee)
                .build();

        return taskRepository.save(taskToBeCreated).getId();
    }

    @Override
    public Long updateTask(TaskUpdateRequest request) {
        Task taskToBeUpdated = getTaskOrThrowException(request.taskId());
        User assignedUser = userService.getUserById(request.assigneeId());

        taskToBeUpdated.setDescription(request.description());
        taskToBeUpdated.setAssignees(assignedUser);
        taskToBeUpdated.setTitle(request.title());
        return taskRepository.save(taskToBeUpdated).getId();
    }

    @Override
    public void deleteTask(Long taskId) {
        taskRepository.deleteById(taskId);
    }

    private Task getTaskOrThrowException(Long taskId) {
        return taskRepository.findById(taskId).orElseThrow(
                () -> new TaskNotFoundException(String.format("Task with id:%d was not found", taskId)));
    }
}
```

### Валідатор
```java
public interface ValidatorService {
    boolean validateOldUserPassword(User user, String newPassword);
}

@Service
public class ValidatorServiceImpl implements ValidatorService {
    @Override
    public boolean validateOldUserPassword(User user, String newPassword) {
        String hashedPassword = newPassword;
        return hashedPassword.equals(user.getPassword());
    }
}
```

### Конфігурація бази даних

```yaml
spring:
    datasource:
        url: "jdbc:postgresql://localhost:5432/max"
        username: "postgres"
        password: "1111"
    jpa:
        hibernate:
            ddl-auto: create-drop
        show-sql: false
        properties:
            hibernate:
                dialect: "org.hibernate.dialect.PostgreSQLDialect"
                format_sql: false
                globally_quoted_identifiers: true
```